name: Pull Request
description: Run the pull request checks, such as building spmgraph for different toolchains and running tests.
on:
  pull_request:
    types: [synchronize, opened, reopened, edited] # The first three are defaults, with 'edited' included the builds will be triggered on things like the base of the branch changing
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.run_id }}'
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:        
  build_and_tests:
    name: Build and run tests
    runs-on: [self-hosted, macOS, ARM64, macstadium, bare-metal] # TODO: Replace with GitHub Action runners once it goes open source
    permissions:
        id-token: write
        contents: read
        checks: write
    steps:
    - name: Check out repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Select Xcode 16.4 toolchain
      uses: ./.github/actions/xcode-version
      with:
        xcode-version: '16.4'
      timeout-minutes: 2
    
    - name: Build spmgraph for Xcode 16.4
      run: set -o pipefail && env NSUnbufferedIO=YES xcodebuild build -scheme spmgraph -destination 'platform=macOS' | xcbeautify
      timeout-minutes: 4

    - name: Run tests on Xcode 16.4
      run: set -o pipefail && env NSUnbufferedIO=YES xcodebuild test -scheme spmgraph -destination 'platform=macOS' | xcbeautify
      timeout-minutes: 4

    - name: Select Xcode 26.0 toolchain
      uses: ./.github/actions/xcode-version
      with:
        xcode-version: '26.0'
      timeout-minutes: 2

    - name: Build spmgraph for Xcode 26.0
      run: set -o pipefail && env NSUnbufferedIO=YES xcodebuild build -scheme spmgraph -destination 'platform=macOS' | xcbeautify
      timeout-minutes: 4
